# F9.4 — Symbol Metadata Parity (Availability, Deprecation, Defaults)

## Task ID & Classification
- **Task ID**: F9.4 (Subtask of F9 Real-World `.doccarchive` Parity Audit)
- **Phase**: C (Markdown Generation) — Parity improvements to render-archive rendering layer
- **Priority**: P1 (blocks F10 Tutorial Parity)
- **Owner**: docc2context agent (unassigned for execution)

---

## Motivation

Real-world DocC render archives (e.g., `SpecificationKit.doccarchive`) include metadata on symbol pages beyond basic declarations and relationships. Analysis of existing symbol rendering reveals that the current implementation extracts only **11 fields** from symbol metadata:

- identifier, title, abstract, discussion, symbolKind, roleHeading, moduleName, topicSections, relationshipSections, declarations, referencesByIdentifier

But Swift-DocC render archives contain **additional critical metadata** not yet decoded or rendered:

- **Availability constraints** (`@available(iOS 14.0+, macOS 11.0+, ...)`) — Platform/OS version requirements
- **Deprecation status** — Deprecated flag + migration guidance to replacement APIs
- **Default implementations** (protocol symbols) — List of types providing default implementations
- **"See Also" cross-references** — Related symbols for navigation

Current implementation silently skips these fields, degrading Markdown parity with Xcode's DocC browser. This task adds support so symbol pages render with complete Xcode-like metadata.

---

## Acceptance Criteria

1. **Availability Metadata Support** — Parse and render `availability` field from render-archive symbol metadata:
   - Format: Human-readable list of platform constraints (e.g., "Available in iOS 14.0 and later")
   - Render as distinct "Availability" section in symbol Markdown (before "See Also" if present)
   - Handle multiple platforms in a single constraint
   - Test: Symbol pages with availability constraints render correctly

2. **Deprecation Support** — Parse and render `deprecated` or `deprecatedSummary` fields:
   - Flag deprecated symbols clearly (e.g., "⚠️ Deprecated" or "**Deprecated**")
   - Include migration guidance if available
   - Render in an early "Deprecation" section or prefix in heading
   - Test: Deprecated symbol pages show deprecation notice + guidance

3. **Default Implementations Section** — For protocol symbols, render default implementation list:
   - Extract default implementors (types that implement the protocol)
   - Render as "Default Implementations" section with type names
   - Format as Markdown list or definition list
   - Test: Protocol symbol pages show default implementations

4. **"See Also" / Related Symbols** — Enhance existing "See Also" or "Related Topics" section:
   - Ensure related symbol links are present and deterministic
   - Cross-reference related APIs with Markdown links
   - Preserve navigation structure from render-archive
   - Test: Symbol pages with related topics render all relationships

5. **Xcode Parity** — Match Xcode DocC browser output:
   - Section ordering matches Xcode (Declaration, Overview, Availability, See Also, etc.)
   - Metadata rendered in human-readable format
   - Link format deterministic across runs

6. **Snapshot Tests** — Update tests for symbol pages with new metadata:
   - Lock rendering format via snapshot comparison
   - Validate against `SpecificationKit.doccarchive` and `Fixtures/Docc2contextCore.doccarchive`

7. **Coverage** — Maintain coverage above 88% threshold (`Docc2contextCore` production code)

---

## Scope & Non-Goals

### In Scope
- Parse `availability` field from render-archive symbol metadata
- Parse `deprecated`/`deprecatedSummary` fields
- Extract default implementation information from protocol symbols
- Render availability as dedicated "Availability" section in Markdown
- Render deprecation notices with migration guidance
- Render "Default Implementations" section for protocols
- Enhance "See Also" / "Related Topics" rendering
- Update snapshot tests for affected symbol pages
- Warning logging for unsupported metadata types

### Out of Scope
- Custom styling beyond Markdown basics (no HTML/CSS)
- Complex nested availability constraints (e.g., conditional availability)
- Automatic migration code generation
- Platform-specific conditional rendering
- Performance optimization of metadata parsing
- Breaking changes to existing symbol page structure

---

## Dependencies & Preconditions

✅ **All satisfied:**
- F9 investigation complete (render-archive structure documented)
- F9.1 complete (commit `f17c7dc`) — Article references render as links
- F9.2 complete (commit `3ef977b`) — Richer block types (asides, images, term lists)
- F9.3 complete (commit `5dfdab7`) — Deeper inline types (links, strikethrough, nesting)
- F5 symbol rendering foundation complete — Swift-DocC render archive symbol pages
- Test infrastructure in place (`SwiftDocCRenderArchiveContentRenderingTests`, snapshot tests)
- Real-world fixture available — `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- Synthetic fixture available — `Fixtures/Docc2contextCore.doccarchive`

---

## Implementation Plan (TDD)

### Phase 1: Identify & Document Symbol Metadata in Archives

1. **Scan `SpecificationKit.doccarchive`** for symbol pages with availability/deprecation metadata:
   - Find `render.json` files containing `availability`, `deprecated`, or default implementations
   - Identify example metadata fields and their structures
   - Document example symbols (e.g., symbols with iOS 13.0+ availability, deprecation notices)

2. **Document findings** in this planning note:
   - Symbol name and category
   - Metadata fields present
   - Expected Markdown rendering format

### Phase 2: Add Failing Tests

1. **Add test cases to `SwiftDocCRenderArchiveContentRenderingTests.swift`**:
   - Test case: `testRenderSymbolPageWithAvailabilityMetadata()`
     - Input: Symbol JSON with `availability` field
     - Expected: Markdown output includes "Availability" section with platform constraints

   - Test case: `testRenderSymbolPageWithDeprecationMetadata()`
     - Input: Symbol JSON with `deprecated` flag and `deprecatedSummary`
     - Expected: Markdown shows deprecation notice + migration guidance

   - Test case: `testRenderProtocolSymbolPageWithDefaultImplementations()`
     - Input: Protocol symbol JSON with default implementations list
     - Expected: "Default Implementations" section with type names

2. **Update snapshot tests**:
   - Re-run snapshots for symbols containing availability/deprecation metadata
   - Lock golden Markdown format

### Phase 3: Implement

1. **Extend RenderNode.Metadata struct** in `DoccMetadataParser.swift`:
   - Add optional fields: `availability: [String]?`, `deprecated: Bool?`, `deprecatedSummary: String?`
   - Add optional field: `defaultImplementations: [String]?` (type names)
   - Update JSON decoding to extract these fields from render-archive metadata

2. **Extend DoccSymbolPage model** (if needed):
   - Add properties for availability, deprecation, default implementations
   - Ensure properties are optional for backward compatibility

3. **Update symbol rendering in `DoccMarkdownRenderer.makeSymbolMetadataSection()`**:
   - Add "Availability" section (if present) with human-readable constraint format
   - Add deprecation notice (if deprecated) with migration guidance
   - Add "Default Implementations" section (if present) for protocol symbols
   - Ensure section ordering matches Xcode (Declaration, Overview, Availability, Deprecation, Defaults, See Also)

4. **Update `loadSwiftDocCRenderArchiveSymbolPages()`**:
   - Decode new metadata fields from render-archive JSON
   - Populate DoccSymbolPage properties with extracted metadata
   - Handle missing/optional fields gracefully

5. **Improve unknown metadata handling**:
   - Log warnings for unrecognized metadata types (don't skip silently)
   - Render fallback for unknown metadata (include in output, don't crash)

### Phase 4: Validate

1. **Run test suite**:
   - `swift test --filter SwiftDocCRenderArchiveContentRenderingTests`
   - All new tests should pass (green phase)

2. **Check coverage**:
   - `python3 Scripts/enforce_coverage.py` confirms ≥88%
   - Metadata rendering code covered by tests

3. **Validate real-world output**:
   - Convert `SpecificationKit.doccarchive` locally:
     - `swift run docc2context DOCS/INPROGRESS/SpecificationKit.doccarchive --output /tmp/f94-out --force`
   - Inspect generated Markdown symbol pages:
     - Verify availability constraints rendered
     - Verify deprecation notices present with guidance
     - Verify default implementations listed (for protocols)
     - Verify "See Also" sections complete

4. **Determinism check**:
   - Convert twice, compare hashes
   - Ensure metadata rendering is deterministic (consistent ordering, escaping)

---

## Success Metrics

- ✅ `testRenderSymbolPageWithAvailabilityMetadata()` passes
- ✅ `testRenderSymbolPageWithDeprecationMetadata()` passes
- ✅ `testRenderProtocolSymbolPageWithDefaultImplementations()` passes
- ✅ All existing tests still pass (no regressions)
- ✅ Coverage maintained ≥88%
- ✅ Determinism verified via dual-run hash comparison
- ✅ Real-world `SpecificationKit.doccarchive` renders with proper availability/deprecation/defaults metadata
- ✅ Snapshot tests updated and locked for affected symbol pages

---

## Fixtures & Test Data

**Primary fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- Real symbol pages with availability, deprecation, and default implementation metadata
- Use for validation and snapshot testing

**Secondary fixture**: `Fixtures/Docc2contextCore.doccarchive`
- May contain symbol pages with availability or deprecation examples
- Use for consistency validation

**Test fixture JSON** (created during Phase 2):
- Minimal symbol with availability constraints
- Deprecated symbol with migration guidance
- Protocol symbol with default implementations

---

## Implementation Evidence (To Be Recorded)

- [ ] Test file: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveContentRenderingTests.swift` — updated with F9.4 test cases
- [ ] Code changes: `Sources/Docc2contextCore/DoccMetadataParser.swift` — metadata field decoding + DoccSymbolPage population
- [ ] Code changes: `Sources/Docc2contextCore/DoccMarkdownRenderer.swift` — symbol metadata section rendering
- [ ] Snapshot golden files: `Tests/__Snapshots__/...` — updated for symbol pages with metadata
- [ ] CI validation: `swift test --enable-code-coverage` passing + determinism check
- [ ] Markdown validation: `python3 Scripts/lint_markdown.py` on generated output

---

## Unblock Conditions

F9.4 **unblocks**:
- F10 Tutorial Parity (depends on consistent metadata rendering across all page types)

---

## Current State

- **Status**: Ready to start (via START.md command)
- **Estimated Effort**: 2–3 hours (metadata field parsing, symbol rendering extension, test cases, snapshot updates)
- **Risk Level**: Low (localized change to symbol metadata extraction and rendering; no architectural shifts)
- **Documentation**: This file + F9 parent task note

---

## Next Steps (START Phase)

1. Scan `SpecificationKit.doccarchive` for availability/deprecation/default implementation examples
2. Add failing test cases for availability, deprecation, and default implementations
3. Extend RenderNode.Metadata struct with new fields
4. Extend DoccSymbolPage model (if needed)
5. Update metadata decoding in `loadSwiftDocCRenderArchiveSymbolPages()`
6. Implement metadata section rendering in `makeSymbolMetadataSection()`
7. Run test suite and verify all tests pass
8. Check coverage and determinism
9. Commit implementation changes
10. Archive this note and update todo.md to mark F9.4 complete

---

## References

- **Parent Task**: `DOCS/INPROGRESS/F9_RealWorldDoccarchiveParityAudit.md`
- **F9.1 Completion**: Commit `f17c7dc` (Article References as Links)
- **F9.2 Completion**: Commit `3ef977b` (Richer Block Types)
- **F9.3 Completion**: Commit `5dfdab7` (Deeper Inline Types)
- **Test File**: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveContentRenderingTests.swift`
- **Metadata Parser**: `Sources/Docc2contextCore/DoccMetadataParser.swift` (lines 1486–2048, symbol loading)
- **Symbol Renderer**: `Sources/Docc2contextCore/DoccMarkdownRenderer.swift` (lines 136–154, metadata section)
- **Symbol Model**: `Sources/Docc2contextCore/DoccSymbolPage.swift`
- **Fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- **Coverage Script**: `Scripts/enforce_coverage.py`

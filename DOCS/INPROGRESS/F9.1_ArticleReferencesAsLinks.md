# F9.1 — Article References as Links

## Task ID & Classification
- **Task ID**: F9.1 (Subtask of F9 Real-World `.doccarchive` Parity Audit)
- **Phase**: C (Markdown Generation) — Parity improvements to render-archive rendering layer
- **Priority**: P1 (blocks F9.2–F9.4 and F10)
- **Owner**: docc2context agent (unassigned for execution)

---

## Motivation
When articles in real-world DocC render archives (e.g., `SpecificationKit.doccarchive`) reference other pages via `reference` nodes, the current implementation renders them as plain titles in article sections. Xcode's DocC browser renders these as hyperlinks when the reference has a `url` property.

This task improves Markdown parity by rendering article references with available URLs as Markdown links instead of bare titles.

---

## Acceptance Criteria
1. **Article sections containing `reference` render-nodes** with `url` properties render as Markdown links in generated `.md` files
2. **Reference titles** are rendered as link text: `[Title](url)`
3. **Fallback behavior** preserved: references without `url` continue to render as titles only (no change to error handling)
4. **Determinism** maintained: repeated conversions of `SpecificationKit.doccarchive` produce byte-identical Markdown
5. **Snapshot tests** updated to lock the new link rendering format
6. **Coverage** maintained above 88% threshold (`Docc2contextCore` production code)

---

## Scope & Non-Goals
### In Scope
- Modify article section rendering to detect `reference` nodes with `url` properties
- Convert those references to Markdown link format
- Update snapshot tests for affected article pages
- Validation via existing `SpecificationKit.doccarchive` fixture

### Out of Scope
- Supporting `link` inline nodes (reserved for F9.3)
- Handling broken/invalid URLs (use existing validation if present)
- Changing symbol page reference rendering (F9.4 scope)
- Performance optimization of reference resolution

---

## Dependencies & Preconditions
✅ **All satisfied:**
- F9 investigation complete (render-archive article structure documented)
- `DOCS/INPROGRESS/SpecificationKit.doccarchive` fixture exists and has article pages with references
- F9 initial implementation landed (commit `55e1ab6`):
  - Article rendering supports lists, code listings, tables
  - Inline `reference`, `strong`, `emphasis` already decoded
  - `SwiftDocCRenderArchiveArticleRenderingTests.swift` exists
- Snapshot test infrastructure in place (`MarkdownSnapshotSpecsTests`, `MarkdownGenerationPipelineTests`)

---

## Implementation Plan (TDD)

### Phase 1: Identify & Document Test Cases
1. **Scan `SpecificationKit.doccarchive`** for article pages with reference nodes containing `url`:
   - Use `swift run docc2context DOCS/INPROGRESS/SpecificationKit.doccarchive --output /tmp/f91-out --force --symbol-layout single`
   - Find articles in `/tmp/f91-out/markdown/articles/documentation/*/`
   - Identify sections mentioning other pages

2. **Record example** in this note:
   - Article name
   - Section with reference
   - Expected Markdown link format

### Phase 2: Add Failing Tests
1. **Add test case to `SwiftDocCRenderArchiveArticleRenderingTests.swift`**:
   - Input: article render-node JSON with `reference` node containing `url`
   - Expected: Markdown output includes `[Title](url)` for that reference
   - Verify: `XCTAssertTrue(output.contains("[")` and URL present in output)

2. **Update snapshot tests**:
   - Re-run snapshots for articles containing references
   - Record golden Markdown link format

### Phase 3: Implement
1. **Locate article rendering code** (likely in `DoccMarkdownRenderer` or `SwiftDocCRenderArchive*` decoders):
   - Find reference-rendering logic for article sections
   - Check current: `reference.title` → plain text output

2. **Add link construction**:
   ```
   if let url = reference.url {
       output += "[\(reference.title)](\(url))"
   } else {
       output += reference.title
   }
   ```

3. **Verify determinism**:
   - Run `swift test --enable-code-coverage` locally
   - Confirm snapshots match expected Markdown link format
   - Ensure URL encoding is deterministic (no randomization)

### Phase 4: Validate
1. **Run test suite**: `swift test --filter SwiftDocCRenderArchiveArticleRenderingTests`
2. **Check coverage**: `python3 Scripts/enforce_coverage.py` confirms ≥88%
3. **Validate determinism**: Convert `SpecificationKit.doccarchive` twice, hash outputs, confirm identical
4. **Lint documentation**: `python3 Scripts/lint_markdown.py` on generated articles

---

## Success Metrics
- ✅ `SwiftDocCRenderArchiveArticleRenderingTests::test_articleReferencesWithUrlRenderAsLinks` passes
- ✅ Snapshot tests updated and locked
- ✅ `swift test` suite passes (160+ tests, 0 failures)
- ✅ Coverage maintained ≥88%
- ✅ Determinism verified via dual-run hash comparison
- ✅ Generated Markdown for `PlatformContextProviders` article (from F9 notes) shows links instead of bare titles

---

## Fixtures & Test Data
**Primary fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- Use real article pages containing references (e.g., `PlatformContextProviders`)
- Verify link rendering matches Xcode output

**Secondary fixture**: `Fixtures/Docc2contextCore.doccarchive` (if articles present; else skip)

---

## Implementation Evidence (To Be Recorded)
- [ ] Test file: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveArticleRenderingTests.swift` — updated with F9.1 test case
- [ ] Snapshot golden files: `Tests/__Snapshots__/...` — re-recorded for articles with links
- [ ] Code changes: Renderer logic in `Sources/Docc2contextCore/...` (exact location TBD during exploration)
- [ ] CI validation: `swift test --enable-code-coverage` passing + determinism check
- [ ] Markdown validation: `python3 Scripts/lint_markdown.py` on generated output

---

## Unblock Conditions
F9.1 **unblocks**:
- F9.2 Richer Block Types (list, code, table support already complete; this adds link support)
- F9.3 Deeper Inline Types (builds on reference → link foundation)
- F9.4 Symbol Metadata Parity (orthogonal; can start after F9.1 structure validated)

---

## Current State
- **Status**: Ready to start (via START.md command)
- **Estimated Effort**: 1–2 hours (2–3 test cases, 1 renderer function update, snapshot re-record)
- **Risk Level**: Low (localized change; existing reference decoding already works)
- **Documentation**: This file + F9 parent task note

---

## Next Steps (START Phase)
1. Run exploration command to identify article references in `SpecificationKit.doccarchive`
2. Add failing test to `SwiftDocCRenderArchiveArticleRenderingTests.swift`
3. Modify article renderer to construct Markdown links
4. Record snapshots
5. Validate `swift test` + coverage + determinism
6. Archive this note and move F9.2 to "Ready to Start"

---

## References
- **Parent Task**: `DOCS/INPROGRESS/F9_RealWorldDoccarchiveParityAudit.md`
- **F9 Initial Work**: Commit `55e1ab6` ("Improve render-archive article rendering and preserve rich Markdown")
- **Test File**: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveArticleRenderingTests.swift`
- **Fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- **Coverage Script**: `Scripts/enforce_coverage.py`
- **Release Gates**: `Scripts/release_gates.sh`


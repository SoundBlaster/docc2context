# F9.2 — Richer Block Types (Asides, Images, Term Lists)

## Task ID & Classification
- **Task ID**: F9.2 (Subtask of F9 Real-World `.doccarchive` Parity Audit)
- **Phase**: C (Markdown Generation) — Parity improvements to render-archive rendering layer
- **Priority**: P1 (blocks F9.3–F9.4 and F10)
- **Owner**: docc2context agent (unassigned for execution)

---

## Motivation

Real-world DocC render archives (e.g., `SpecificationKit.doccarchive`) use block types beyond the basic six currently supported (heading, paragraph, lists, code, table). Analysis of the fixture reveals:

- **Asides** (`aside` type with `style: "note"`) — Used for callouts, warnings, and notes in symbol descriptions
- **Images/Media** — Found in some documentation sections (placeholder support needed)
- **Term Lists** — Definition lists for structured terminology

Current implementation skips these types silently, degrading Markdown parity with Xcode's DocC browser. This task adds support so articles, symbols, and tutorials render with richer visual structure.

---

## Acceptance Criteria

1. **Aside/Callout Support** — Render `aside` nodes with `style` attribute (note, warning, important, etc.) as:
   - Markdown blockquotes with style-specific prefixes (`**Note:**`, `**Warning:**`, etc.)
   - Or collapsible sections if appropriate for Markdown output
   - Test: `CompositeContextProvider` article renders note aside correctly

2. **Image Support (Placeholder)** — Recognize `image` block type and render as:
   - Markdown image syntax: `![alt text](url)`
   - Or inline Alt text link if URL unavailable: `[Image: alt text]`
   - Graceful fallback: emit link if image URL unresolvable

3. **Term List Support** — Render `termList` nodes as:
   - Markdown definition list format (or indented pairs if GFM not available)
   - Preserve term-definition relationship and order
   - Test: Example term list from fixture renders deterministically

4. **Fallback Behavior** — Preserve existing behavior:
   - Unknown block types logged as warnings (not silent skips)
   - Markdown output remains valid even if unsupported types encountered
   - Determinism maintained: repeated conversions produce identical output

5. **Snapshot Tests** — Update tests for affected articles, symbols, and tutorials
   - Lock new rendering format via snapshot comparison
   - Validate against `SpecificationKit.doccarchive` fixture

6. **Coverage** — Maintain coverage above 88% threshold (`Docc2contextCore` production code)

---

## Scope & Non-Goals

### In Scope
- Add `aside` block type support to articles, symbols, and tutorials
- Add basic `image` block type support (render as Markdown image or fallback link)
- Add `termList` block type support to articles and symbols
- Update rendering switches in `DoccMetadataParser` for article/tutorial blocks
- Update `renderSwiftDocCArchiveSymbolPages()` for symbol blocks (symbols may already have partial support)
- Snapshot tests validating new block rendering
- Warning logging for unsupported block types

### Out of Scope
- Complex nested block structures (e.g., blockquote inside aside)
- Media type detection/validation (assume provided URLs are valid)
- Styling beyond Markdown basics (no HTML/CSS injection)
- Video/multimedia embed support (separate F9.3+ feature)
- Performance optimization of block rendering
- Accessibility metadata beyond Markdown conventions

---

## Dependencies & Preconditions

✅ **All satisfied:**
- F9.1 implementation complete (commit `f17c7dc`)
- Article rendering supports lists, code, tables, and references
- Symbol rendering partially supports asides (may need extension)
- `SpecificationKit.doccarchive` fixture available for validation
- Test infrastructure (`MarkdownSnapshotSpecsTests`, test utilities) in place
- Render-archive JSON decoding ready to extract new block types

---

## Implementation Plan (TDD)

### Phase 1: Identify & Document Block Type Usage

1. **Scan `SpecificationKit.doccarchive`** for block type examples:
   - Search for `"type": "aside"` in render.json files
   - Identify `style` values (note, warning, important, tip, etc.)
   - Document examples in this planning note

2. **Record examples** found:
   - ✅ **Asides found**: `CompositeContextProvider` article contains `aside` with `style: "note"`
   - Example: `{"name":"Note","style":"note","type":"aside","content":[...]}`
   - Content follows standard block structure (nested paragraphs, lists, etc.)

3. **Search for images and term lists** (may be absent in current fixture):
   - If not found in SpecificationKit, note as "discovered via code review"
   - Plan placeholder support for future real-world usage

### Phase 2: Add Failing Tests

1. **Add test cases to relevant test files**:
   - **Article tests** (`SwiftDocCRenderArchiveArticleRenderingTests.swift`):
     - Test case: `testRenderArchiveArticleRendersAsidesAsBlockquotes()` or similar
     - Input: Article JSON with aside block containing note/warning styles
     - Expected: Markdown blockquote output with style prefix

   - **Symbol tests** (`SwiftDocCRenderArchiveContentRenderingTests.swift`):
     - Verify existing aside support or add if missing
     - Test nested asides and complex content

   - **Image handling** (if examples found or for placeholder):
     - Test case: `testRenderArchiveArticleRendersImagesAsMarkdownLinks()`
     - Input: Article JSON with image block
     - Expected: `![alt text](url)` format

2. **Snapshot tests**:
   - Re-run snapshots for articles containing new block types
   - Lock golden Markdown format for `CompositeContextProvider` article

### Phase 3: Implement

1. **Extend RenderContentBlock struct** (if needed):
   - Add optional fields for aside `style` and `name`
   - Add optional fields for image `source` and `altText`
   - Add optional fields for term list items

2. **Update RenderContentType enum** in `DoccArticle`:
   - Add cases: `aside`, `image`, `termList` (alongside existing `heading`, `paragraph`, etc.)

3. **Implement article block rendering**:
   - Locate `renderContentBlocks()` in `parseRenderArchiveSections()` (approx. line 508)
   - Add new cases to the switch statement:
     ```swift
     case .aside:
         if let style = block.style, !style.isEmpty {
             let prefix = stylePrefix(for: style)  // "Note:", "Warning:", etc.
             let content = renderContentBlocks(block.content ?? []).joined(separator: "\n")
             rendered.append("> **\(prefix)** \(content)")
         }
     case .image:
         if let source = block.source {
             let alt = block.altText ?? "Image"
             rendered.append("![\(alt)](\(source))")
         }
     case .termList:
         for item in block.items ?? [] {
             // Render term-definition pairs
         }
     ```

4. **Verify symbol rendering**:
   - Check if `loadSwiftDocCRenderArchiveSymbolPages()` already handles asides
   - Extend if needed for consistency with article rendering

5. **Add warning logging for unknown types**:
   - Replace silent `.none` case with logged warning
   - Use structured logging (consistent with Phase D logging work)

### Phase 4: Validate

1. **Run test suite**:
   - `swift test --filter SwiftDocCRenderArchiveArticleRenderingTests`
   - `swift test --filter SwiftDocCRenderArchiveContentRenderingTests`
   - All new tests should pass (green phase)

2. **Check coverage**:
   - `python3 Scripts/enforce_coverage.py` confirms ≥88%
   - New block handling code covered by snapshot tests

3. **Validate Markdown output**:
   - Convert `SpecificationKit.doccarchive` locally:
     - `swift run docc2context DOCS/INPROGRESS/SpecificationKit.doccarchive --output /tmp/f92-out --force`
   - Inspect generated Markdown:
     - Verify asides render as blockquotes
     - Verify images render as links (or images if supported)
     - Verify term lists preserve structure

4. **Determinism check**:
   - Convert twice, compare hashes
   - Ensure block rendering is deterministic (consistent ordering, escaping)

---

## Success Metrics

- ✅ `SwiftDocCRenderArchiveArticleRenderingTests::testRenderArchiveArticleRendersAsidesAsBlockquotes()` passes
- ✅ Snapshot tests updated and locked for articles with asides
- ✅ `swift test` suite passes (179+ tests, 0 failures)
- ✅ Coverage maintained ≥88%
- ✅ Determinism verified via dual-run hash comparison
- ✅ `CompositeContextProvider` article renders aside with blockquote syntax
- ✅ Image and term list support implemented (at least placeholder for future real-world usage)

---

## Fixtures & Test Data

**Primary fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- Real article pages containing asides (e.g., `CompositeContextProvider`)
- Verify aside rendering matches Xcode output

**Secondary fixture**: `Fixtures/Docc2contextCore.doccarchive`
- May contain symbol pages with asides or other block types
- Use for consistency validation

**Test fixture JSON** (created during Phase 2):
- Minimal article with aside block for unit testing
- Minimal article with image block
- Minimal article with term list block

---

## Implementation Evidence (To Be Recorded)

- [ ] Test file: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveArticleRenderingTests.swift` — updated with F9.2 test cases
- [ ] Code changes: `Sources/Docc2contextCore/DoccMetadataParser.swift` — new block type handling in `renderContentBlocks()`
- [ ] Snapshot golden files: `Tests/__Snapshots__/...` — re-recorded for articles with asides/images/term lists
- [ ] CI validation: `swift test --enable-code-coverage` passing + determinism check
- [ ] Markdown validation: `python3 Scripts/lint_markdown.py` on generated output

---

## Unblock Conditions

F9.2 **unblocks**:
- F9.3 Deeper Inline Types (uses block rendering foundation)
- F9.4 Symbol Metadata Parity (builds on richer block support)
- F10 Tutorial Parity (tutorials need parity with articles for consistency)

---

## Current State

- **Status**: Ready to start (via START.md command)
- **Estimated Effort**: 2–3 hours (block type enum + switch cases, test cases, snapshot re-recording)
- **Risk Level**: Low (localized change to rendering switches; no architectural shifts)
- **Documentation**: This file + F9 parent task note

---

## Next Steps (START Phase)

1. Verify aside block type support by running test suite locally
2. Add failing test cases for aside/image/term list rendering
3. Extend RenderContentBlock and RenderContentType
4. Implement rendering logic in renderContentBlocks()
5. Add warning logging for unsupported block types
6. Verify symbol rendering handles asides (extend if needed)
7. Record snapshots and validate determinism
8. Confirm `swift test` + coverage + determinism gates pass
9. Archive this note and move F9.3 to "Ready to Start"

---

## References

- **Parent Task**: `DOCS/INPROGRESS/F9_RealWorldDoccarchiveParityAudit.md`
- **F9.1 Completion**: Commit `f17c7dc` (Article References as Links)
- **Test File**: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveArticleRenderingTests.swift`
- **Rendering File**: `Sources/Docc2contextCore/DoccMetadataParser.swift` (lines 505–596 article rendering, lines 1608–1702 symbol rendering)
- **Fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- **Coverage Script**: `Scripts/enforce_coverage.py`
- **Release Gates**: `Scripts/release_gates.sh`


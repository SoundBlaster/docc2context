# F9.3 — Deeper Inline Types (Links, Nested Structures)

## Task ID & Classification
- **Task ID**: F9.3 (Subtask of F9 Real-World `.doccarchive` Parity Audit)
- **Phase**: C (Markdown Generation) — Parity improvements to render-archive rendering layer
- **Priority**: P1 (blocks F9.4 and F10)
- **Owner**: docc2context agent (unassigned for execution)

---

## Motivation

Real-world DocC render archives use inline content types beyond the five currently supported (text, codeVoice, strong, emphasis, reference). Analysis reveals:

- **Link nodes** (`link` type) — Direct hyperlinks with URL and title, distinct from reference nodes
- **Nested inline structures** — Complex combinations like bold inside emphasis, code inside links
- **Strikethrough** (`strikethrough` type) — Text deletion markers
- **Superscript/Subscript** — Mathematical notation support

Current implementation silently skips unknown inline types, degrading content fidelity. This task adds support for link nodes and improves nested structure handling to match Xcode DocC browser output.

---

## Acceptance Criteria

1. **Link Node Support** — Render `link` nodes with URL and inline content as Markdown links:
   - Format: `[inline_content](url)`
   - Handle both absolute and relative URLs
   - Preserve nested inline content (e.g., bold text inside link)
   - Test: Verify article/symbol pages with link nodes render correctly

2. **Nested Inline Structure Support** — Properly handle recursive nesting:
   - Strong/emphasis containing code, text, or other nested types
   - Links containing bold, italic, or other inline formatting
   - Recursive renderInlineText() calls preserve all formatting
   - Test: Complex inline examples from real archives render deterministically

3. **Strikethrough Support** — Render `strikethrough` nodes as:
   - Markdown strikethrough: `~~text~~` (if GFM supported)
   - Or fallback: plain text (if Markdown variant doesn't support strikethrough)
   - Graceful degradation if backend doesn't support syntax

4. **Improved Unknown Type Handling** — Replace silent skips with:
   - Warning logging for unrecognized inline types (don't skip silently)
   - Render unknown types as plain text fallback
   - Test: Unknown types are logged but don't crash conversion

5. **Snapshot Tests** — Update tests for affected content:
   - Lock rendering format for articles/symbols with link nodes
   - Validate against `SpecificationKit.doccarchive` fixture

6. **Coverage** — Maintain coverage above 88% threshold (`Docc2contextCore` production code)

---

## Scope & Non-Goals

### In Scope
- Implement `link` inline type rendering as Markdown links
- Improve nested inline structure handling (already partially works via recursion)
- Add basic `strikethrough` support
- Replace silent unknown type skips with warning logging
- Add test cases validating new inline types
- Update snapshot tests if needed
- Verify determinism and coverage

### Out of Scope
- Superscript/subscript support (rare in DocC, requires HTML/Unicode workarounds)
- Advanced inline types (video embeds, complex media)
- URL validation or normalization beyond current reference handling
- Performance optimization of inline rendering
- Breaking changes to existing inline API

---

## Dependencies & Preconditions

✅ **All satisfied:**
- F9.1 complete (commit `f17c7dc`) — reference rendering with URLs established
- F9.2 complete (commit `3ef977b`) — block type rendering extended
- Inline content structure stable (RenderInlineContent supports nesting)
- Test infrastructure in place (snapshot tests, inline content examples)
- SpecificationKit.doccarchive available for validation

---

## Implementation Plan (TDD)

### Phase 1: Identify & Document Inline Type Usage

1. **Scan real archives** for link node examples:
   - Search SpecificationKit.doccarchive JSON for `"type": "link"` nodes
   - Identify example URLs and inline content
   - Document strikethrough and other undocumented types if present

2. **Analyze current test examples**:
   - Review existing inline content examples in test files
   - Identify potential nested structures to test
   - Plan complex test cases (nested emphasis, link with code, etc.)

### Phase 2: Add Failing Tests

1. **Add test cases for link rendering**:
   - Test case: `testRenderArticleWithLinkInlineContent()`
   - Input: Article with paragraph containing link node
   - Expected: Markdown link format `[text](url)` in output

2. **Add test cases for nested structures**:
   - Test case: `testRenderArticleWithComplexNestedInlineContent()`
   - Input: Emphasis containing strong containing code
   - Expected: Nested formatting preserved in output

3. **Add test cases for strikethrough**:
   - Test case: `testRenderArticleWithStrikethroughContent()`
   - Input: Paragraph with strikethrough inline content
   - Expected: `~~text~~` in output

4. **Add test cases for unknown types**:
   - Verify warning logging works (may require structured logging check)
   - Verify unknown types render as plain text fallback

### Phase 3: Implement

1. **Extend RenderInlineContent** (if needed):
   - Add optional fields: `href: String?` for link URLs
   - Verify nested `inlineContent` field is properly decoded

2. **Update inline rendering switch statements**:
   - Add case for `link` type (all three contexts: articles, tutorials, symbols)
   - Render as: `[renderInlineText(content)](url)`
   - Handle cases where inline content is missing (use placeholder text)

3. **Add strikethrough support**:
   - Add case for `strikethrough` type
   - Render nested content between `~~` markers
   - Fallback to plain text if strikethrough not supported in target format

4. **Improve unknown type handling**:
   - Replace `default: continue` with logging + fallback
   - Log unknown inline type with context (article/section/paragraph)
   - Render unknown types as plain text (extract from inline content if present)

### Phase 4: Validate

1. **Run test suite**:
   - `swift test --filter SwiftDocCRenderArchiveArticleRenderingTests`
   - All new tests should pass

2. **Check coverage**:
   - `python3 Scripts/enforce_coverage.py` confirms ≥88%
   - Link/strikethrough rendering code covered by tests

3. **Validate real-world output**:
   - Convert SpecificationKit.doccarchive with new inline types
   - Inspect generated Markdown for link, strikethrough, nested formatting
   - Verify determinism: convert twice, compare hashes

4. **Validate logging** (if logging added):
   - Ensure unknown inline types are logged but don't break conversion
   - Verify log output shows type and context

---

## Success Metrics

- ✅ `testRenderArticleWithLinkInlineContent()` passes
- ✅ `testRenderArticleWithComplexNestedInlineContent()` passes
- ✅ `testRenderArticleWithStrikethroughContent()` passes
- ✅ `testUnknownInlineTypesLogWarning()` passes (if logging validation added)
- ✅ All existing tests still pass (no regressions)
- ✅ Coverage maintained ≥88%
- ✅ Determinism verified via dual-run hash comparison
- ✅ Real-world SpecificationKit.doccarchive renders with proper link/strikethrough formatting

---

## Fixtures & Test Data

**Primary fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- Search for real `link` nodes and `strikethrough` usage
- If found, use for snapshot validation

**Secondary fixture**: `Fixtures/Docc2contextCore.doccarchive`
- May contain inline examples with links or strikethrough

**Test fixture JSON** (created during Phase 2):
- Minimal article with link inline node
- Complex nested inline structure
- Strikethrough example

---

## Implementation Evidence (To Be Recorded)

- [ ] Test file: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveArticleRenderingTests.swift` — updated with F9.3 test cases
- [ ] Code changes: `Sources/Docc2contextCore/DoccMetadataParser.swift` — link/strikethrough handling in renderInlineText()
- [ ] Snapshot golden files: `Tests/__Snapshots__/...` — updated if article/symbol content changed
- [ ] CI validation: `swift test --enable-code-coverage` passing + determinism check
- [ ] Markdown validation: `python3 Scripts/lint_markdown.py` on generated output

---

## Unblock Conditions

F9.3 **unblocks**:
- F9.4 Symbol Metadata Parity (depends on inline type richness for availability annotations)
- F10 Tutorial Parity (uses consistent inline rendering across all page types)

---

## Current State

- **Status**: Ready to start (via START.md command)
- **Estimated Effort**: 1.5–2 hours (link/strikethrough cases, nested test cases, snapshot updates)
- **Risk Level**: Low (localized change to inline rendering switch)
- **Documentation**: This file + F9 parent task note

---

## Next Steps (START Phase)

1. Search SpecificationKit.doccarchive for link node examples
2. Add failing test cases for link, strikethrough, complex nesting
3. Implement link rendering in renderInlineText()
4. Implement strikethrough rendering
5. Improve unknown type handling with logging/fallback
6. Run test suite and verify all pass
7. Check coverage and determinism
8. Commit implementation
9. Archive this note and move F9.4 to "Ready to Start"

---

## References

- **Parent Task**: `DOCS/INPROGRESS/F9_RealWorldDoccarchiveParityAudit.md`
- **F9.1 Completion**: Commit `f17c7dc` (Article References as Links)
- **F9.2 Completion**: Commit `3ef977b` (Richer Block Types)
- **Inline Rendering Code**: `Sources/Docc2contextCore/DoccMetadataParser.swift` lines 504–528 (articles), 817–835 (tutorials), 1638–1655 (symbols)
- **Test File**: `Tests/Docc2contextCoreTests/SwiftDocCRenderArchiveArticleRenderingTests.swift`
- **Fixture**: `DOCS/INPROGRESS/SpecificationKit.doccarchive`
- **Coverage Script**: `Scripts/enforce_coverage.py`


# H1.1 â€“ Cloudsmith Publishing Variant Filtering (Exclude `-musl` by default)

**Status:** Completed
**Date:** 2025-12-17
**Owner:** docc2context agent
**PRD/Workplan Link:** Phase H (H1); distribution hardening follow-up
**Depends On:** None (build artifacts and Cloudsmith helper already exist)

---

## ğŸ¯ Objective

Make `Scripts/publish_to_cloudsmith.sh` safe and usable against the current release artifact layout by **excluding musl variant packages (`*-musl.deb` / `*-musl.rpm`) by default**.

Rationale: both glibc and musl packages are currently built with the same package name/version metadata (e.g., `Package: docc2context` and `Name: docc2context`). Uploading both variants for the same version/arch to a single apt/dnf repository is expected to conflict or overwrite, producing an ambiguous installation story.

---

## âœ… Acceptance Criteria

- [ ] `Scripts/publish_to_cloudsmith.sh --dry-run` only plans uploads for non-variant packages by default (no `-musl` basenames).
- [ ] The script logs a warning when variant artifacts are present but skipped.
- [ ] Tests cover the default filtering behavior and remain deterministic.
- [ ] `.github/SECRETS.md` and `README.md` clarify that the Cloudsmith repository publishes **glibc packages only** until package metadata differentiates variants.

---

## ğŸ“ Implementation Plan (TDD)

1. Add a test that creates both glibc and musl artifacts and asserts the dry-run output **does not include** `-musl` uploads.
2. Update the script to filter `deb_files` / `rpm_files` by basename, skipping `*-musl.*` and emitting a warning.
3. Update docs to reflect the intended behavior and operator expectations.

---

## ğŸ” Notes / Constraints

- This change is intentionally conservative: it does **not** attempt to rename packages or create multiple repositories per variant.
- Follow-up task (future): add an explicit opt-in flag (e.g., `--include-musl`) once we decide on repository layout and package naming.

---

## âœ… Implementation Notes

- Updated `Scripts/publish_to_cloudsmith.sh` to skip `*-musl.deb` and `*-musl.rpm` by default and emit warnings listing skipped artifacts.
- Added `CloudsmithPublishScriptTests.test_dryRunSkipsMuslVariantArtifactsByDefault` to lock in the behavior.
- Updated `.github/SECRETS.md` and the Cloudsmith README section to document the glibc-only publishing policy.

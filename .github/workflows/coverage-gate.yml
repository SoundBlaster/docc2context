name: Coverage Gate

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "Sources/**"
      - "Tests/**"
      - "Package.swift"

jobs:
  coverage:
    runs-on: ubuntu-latest
    container:
      image: swift:6.0
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Build & test with coverage
        run: swift test --enable-code-coverage

      - name: Locate coverage profile
        run: |
          PROFILE=$(find .build -name '*.profdata' | head -n1)
          echo "PROFILE=$PROFILE" >> "$GITHUB_ENV"

      - name: Generate lcov
        run: |
          llvm-cov export \
            -format=lcov \
            .build/debug/docc2contextPackageTests.xctest \
            -instr-profile "$PROFILE" \
            > coverage.lcov

      - name: Generate HTML report
        run: |
          mkdir -p coverage-html
          llvm-cov show \
            .build/debug/docc2contextPackageTests.xctest \
            -instr-profile "$PROFILE" \
            -format=html \
            -output-dir coverage-html \
            -ignore-filename-regex=".build|Tests/.*Snapshot"

      - name: Enforce minimum line coverage for Docc2contextCore
        run: |
          MIN_CORE_COVERAGE="${MIN_CORE_COVERAGE:-88.5}"
          llvm-cov report \
            .build/debug/docc2contextPackageTests.xctest \
            -instr-profile "$PROFILE" \
            -ignore-filename-regex=".build|Tests/.*Snapshot" \
            > coverage.txt
          awk -v min="$MIN_CORE_COVERAGE" '/Sources\/Docc2contextCore\// { if ($10+0 < min) { print "Coverage", $10"% (min:", min"%)"; exit 1 } }' coverage.txt

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.lcov
            coverage.txt
            coverage-html

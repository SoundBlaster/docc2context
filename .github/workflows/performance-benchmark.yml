name: Performance Benchmark

on:
  workflow_dispatch:
  pull_request:
    types: [labeled, opened, reopened, synchronize]

jobs:
  benchmark:
    if: github.event_name == 'workflow_dispatch' || contains(join(github.event.pull_request.labels.*.name, ','), 'perf-check')
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Validate Swift toolchain
        run: swift --version

      - name: Build (release)
        run: swift build -c release

      - name: Run performance benchmark with baseline comparison
        run: |
          swift run --disable-sandbox docc2context-benchmark \
            --synthesize-megabytes 10 \
            --iterations 3 \
            --threshold-seconds 10 \
            --baseline Benchmarks/performance-baseline.json \
            --tolerance-average 2.0 \
            --tolerance-max 2.0 \
            --fail-on-regression \
            --metrics-json benchmark.json \
            --output .build/benchmark

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-metrics
          path: benchmark.json
          if-no-files-found: error
